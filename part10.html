<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 1600,
    height: 1600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 1000 },
            debug: false
        }
    },
    scene: {
        preload: preload, create: create, update: update
    }
};


var gameOver = false;
var platformes;

var sautBonus=1; //on peut faire un saut en plus en l'air

var game = new Phaser.Game(config);

function preload ()
{
    this.load.image("Phaser_tuilesdejeu", "assets/tuiles_de_jeu.png");
    this.load.tilemapTiledJSON("carte", "assets/map.json");
    this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });
}

function create ()
{

    const carteDuNiveau = this.add.tilemap("carte");

    const tileset = carteDuNiveau.addTilesetImage(
        "tuiles_de_jeu",
        "Phaser_tuilesdejeu"
    ); 

    console.log(carteDuNiveau);
    const calque_background = carteDuNiveau.createStaticLayer(
        "calque_background",
        tileset
    );

    const calque_background_2 = carteDuNiveau.createStaticLayer(
        "calque_background_2",
        tileset
    );
    
    const calque_plateformes = carteDuNiveau.createStaticLayer(
        "calque_plateformes",
        tileset
    );

    calque_plateformes.setCollisionByProperty({ estSolide: true }); 



    // The player and its settings
    this.player = this.physics.add.sprite(0, 0, 'dude');

    //  Player physics properties. Give the little guy a slight bounce.
    this.player.setCollideWorldBounds(true);

    //  Our player animations, turning, walking left and walking right.
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'dude', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });

    //  Input Events
    this.cursors = this.input.keyboard.createCursorKeys();

   // this.physics.add.collider(this.player, plateformes); 


    // redimentionnement du monde avec les dimensions calculées via tiled
    this.physics.world.setBounds(0, 0, 1600, 1600);
    //  ajout du champs de la caméra de taille identique à celle du monde
    this.cameras.main.setBounds(0, 0, 1600, 1600);
    // ancrage de la caméra sur le joueur
    this.cameras.main.startFollow(this.player); 


}

function update ()
{
    if (gameOver)
    {
        return;
    }

    if (this.cursors.left.isDown)
    {
        this.player.setVelocityX(-160);

        this.player.anims.play('left', true);
    }
    else if (this.cursors.right.isDown)
    {
        this.player.setVelocityX(160);

        this.player.anims.play('right', true);
    }
    else
    {
        this.player.setVelocityX(0);

        this.player.anims.play('turn');
    }

    if (this.input.keyboard.checkDown(this.cursors.up,3000)==true){
        if (this.player.body.touching.down){
        //si touche haut appuyée ET que le perso touche le sol
            dash = 0;
            player.setVelocityY(-590); //alors vitesse verticale négative
            //(on saute)
            }
        else if(sautBonus>0){//sinon c'est qu'on est en l'air : on vérifie si il te reste un saut bonus
            dash = 0;
            this.player.setVelocityY(-590);
            sautBonus-=1
                }

    } 
    if (this.player.body.touching.down){sautBonus = 1}// on redonne le saut une fois que le perso atterit 
}

</script>

</body>
</html>